# 移动应用准确率改进说明

## 问题分析

通过对比 `predict_microphone.py`（PC端）和移动应用的实现，发现了以下关键差异导致准确率不高：

### 1. Mel频谱图生成不准确
- **PC端**：使用 `torchaudio.transforms.MelSpectrogram`，基于真实的FFT和Mel滤波器组
- **移动端**：使用简化的模拟实现，基于统计特征而非真实频域分析

### 2. 预处理流程不一致
- **PC端流程**：
  1. 降噪（可选）
  2. 带通滤波（可选）
  3. Z-score归一化
  4. Mel频谱图转换（FFT + Mel滤波器组）
  5. 转换为dB
  6. Min-Max归一化到[-1, 1]

- **移动端原流程**：
  1. 降噪/滤波
  2. 归一化
  3. 简化的Mel频谱图（模拟）

### 3. 归一化方法不同
- **PC端**：Min-Max归一化到[-1, 1]，使用全局最小值和最大值
- **移动端**：简化的dB转换和归一化

## 改进方案

### 1. 创建 `MelSpectrogramGenerator.ts`
实现了完整的Mel频谱图生成器，包括：
- **FFT实现**：迭代FFT算法（性能优化）
- **Mel滤波器组**：预计算的64个Mel滤波器（50-4000 Hz）
- **功率谱计算**：从FFT结果计算功率谱
- **Mel转换**：应用Mel滤波器组
- **dB转换**：转换为分贝刻度
- **归一化**：Min-Max归一化到[-1, 1]，与PC端一致

### 2. 改进 `ModelInference.ts`
- 移除了简化的Mel频谱图生成方法
- 使用新的 `MelSpectrogramGenerator` 进行真实的Mel频谱图转换
- 确保预处理流程与PC端完全一致：
  1. Z-score归一化
  2. Mel频谱图转换
  3. Min-Max归一化到[-1, 1]

### 3. 调整 `AudioProcessor.ts`
- 预处理时不再进行归一化（与PC端保持一致）
- 只进行降噪和滤波处理
- 归一化在Mel频谱图转换时统一进行

## 技术细节

### FFT实现
使用迭代FFT算法（Cooley-Tukey），比递归实现性能更好：
- 位反转重排
- 迭代计算，避免递归开销
- 针对1024点FFT优化

### Mel滤波器组
- 预计算64个Mel滤波器
- 频率范围：50-4000 Hz
- 使用标准的Hz↔Mel转换公式

### 性能优化
- 预计算Mel滤波器组（避免重复计算）
- 使用迭代FFT（比递归快）
- 优化数组操作，减少内存分配

## 预期效果

改进后的移动应用应该能够：
1. **生成真实的Mel频谱图**，与PC端一致
2. **预处理流程完全对齐**，确保特征提取准确
3. **归一化方法一致**，保证模型输入格式正确

这些改进应该能显著提高移动应用的检测准确率，使其接近PC端的性能。

## 使用建议

1. **启用降噪和滤波**：在安静环境下可能不需要，但在有噪声的环境中建议启用
2. **性能考虑**：FFT计算可能较慢，如果性能不足，可以考虑：
   - 使用原生模块实现FFT（C++/Kotlin/Swift）
   - 减少检测频率
   - 使用Web Workers进行后台计算

## 后续优化方向

1. **原生模块实现**：将FFT和Mel频谱图转换移到原生模块（C++/Kotlin/Swift），性能会更好
2. **缓存优化**：预计算更多数据，减少运行时计算
3. **并行处理**：使用多线程处理音频数据



