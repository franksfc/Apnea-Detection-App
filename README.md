# ç¡çœ å‘¼å¸æš‚åœæ£€æµ‹ç³»ç»Ÿ

ä¸€ä¸ªåŸºäºæ·±åº¦å­¦ä¹ çš„ç¡çœ å‘¼å¸æš‚åœå®æ—¶æ£€æµ‹ç³»ç»Ÿï¼Œæ”¯æŒPCç«¯å®æ—¶æ£€æµ‹å’Œç§»åŠ¨ç«¯éƒ¨ç½²ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [æ•°æ®é›†](#æ•°æ®é›†)
- [å®ç°åŸç†](#å®ç°åŸç†)
- [ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)
- [å®‰è£…æ­¥éª¤](#å®‰è£…æ­¥éª¤)
- [è®­ç»ƒæ¨¡å‹](#è®­ç»ƒæ¨¡å‹)
- [æ¨¡å‹è½¬æ¢](#æ¨¡å‹è½¬æ¢)
- [PCç«¯å®æ—¶æ£€æµ‹](#pcç«¯å®æ—¶æ£€æµ‹)
- [ç§»åŠ¨ç«¯éƒ¨ç½²](#ç§»åŠ¨ç«¯éƒ¨ç½²)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

## é¡¹ç›®ç®€ä»‹

æœ¬ç³»ç»Ÿä½¿ç”¨2D CNNæ¨¡å‹å¯¹éŸ³é¢‘ä¿¡å·è¿›è¡Œç¡çœ å‘¼å¸æš‚åœæ£€æµ‹ã€‚é€šè¿‡åˆ†æ10ç§’éŸ³é¢‘ç‰‡æ®µçš„Melé¢‘è°±å›¾ï¼Œç³»ç»Ÿèƒ½å¤Ÿå®æ—¶åˆ¤æ–­æ˜¯å¦å­˜åœ¨å‘¼å¸æš‚åœäº‹ä»¶ã€‚

### ä¸»è¦ç‰¹æ€§

- âœ… **é«˜ç²¾åº¦æ£€æµ‹**: åŸºäºæ·±åº¦å­¦ä¹ çš„2D CNNæ¨¡å‹ï¼Œå‡†ç¡®è¯†åˆ«å‘¼å¸æš‚åœäº‹ä»¶
- âœ… **å®æ—¶æ£€æµ‹**: æ”¯æŒPCç«¯éº¦å…‹é£å®æ—¶å½•éŸ³å’Œæ£€æµ‹
- âœ… **ç§»åŠ¨ç«¯éƒ¨ç½²**: æ”¯æŒAndroid/iOSç§»åŠ¨åº”ç”¨éƒ¨ç½²
- âœ… **æ»‘åŠ¨çª—å£ç®—æ³•**: ç§»åŠ¨ç«¯ä½¿ç”¨æ»‘åŠ¨çª—å£å®ç°è¿ç»­ç›‘æµ‹
- âœ… **æ³¨æ„åŠ›æœºåˆ¶**: æ¨¡å‹é›†æˆCBAMæ³¨æ„åŠ›æ¨¡å—ï¼Œæå‡ç‰¹å¾æå–èƒ½åŠ›

## æ•°æ®é›†

### æ•°æ®æ¥æº

æœ¬é¡¹ç›®ä½¿ç”¨çš„æ•°æ®é›†åŸºäº **PSG-Audio** æ•°æ®é›†ï¼Œå…·ä½“ä¿¡æ¯å¦‚ä¸‹ï¼š

#### åŸå§‹æ•°æ®é›†

- **æ¥æº**: Science Data Bank (ç§‘å­¦æ•°æ®é“¶è¡Œ)
- **æ•°æ®é›†ID**: 778740145531650048
- **é“¾æ¥**: [https://www.scidb.cn/en/detail?dataSetId=778740145531650048](https://www.scidb.cn/en/detail?dataSetId=778740145531650048)

#### é¢„å¤„ç†ç‰ˆæœ¬ï¼ˆæœ¬é¡¹ç›®å®é™…ä½¿ç”¨ï¼‰

- **æ¥æº**: Kaggle
- **æ•°æ®é›†åç§°**: PSG-Audio Apnea Audios
- **é“¾æ¥**: [https://www.kaggle.com/datasets/bryandarquea/psg-audio-apnea-audios](https://www.kaggle.com/datasets/bryandarquea/psg-audio-apnea-audios)
- **è¯´æ˜**: è¿™æ˜¯åŸå§‹PSG-Audioæ•°æ®é›†çš„é¢„å¤„ç†ç‰ˆæœ¬ï¼Œå·²è½¬æ¢ä¸ºé€‚åˆæœºå™¨å­¦ä¹ è®­ç»ƒçš„æ ¼å¼

### æ•°æ®é›†ç»“æ„

æ•°æ®é›†åŒ…å«å¤šä¸ªæ‚£è€…çš„ç¡çœ éŸ³é¢‘æ•°æ®ï¼Œæ¯ä¸ªæ‚£è€…åŒ…å«ä¸¤ç±»æ ·æœ¬ï¼š

```
psg-audio-apnea-audios/
â””â”€â”€ PSG-AUDIO/
    â””â”€â”€ APNEA_EDF/
        â”œâ”€â”€ patient_001/
        â”‚   â”œâ”€â”€ patient_001_ap.npy    # å‘¼å¸æš‚åœæ ·æœ¬
        â”‚   â””â”€â”€ patient_001_nap.npy  # æ­£å¸¸æ ·æœ¬
        â”œâ”€â”€ patient_002/
        â”‚   â”œâ”€â”€ patient_002_ap.npy
        â”‚   â””â”€â”€ patient_002_nap.npy
        â””â”€â”€ ...
```

### æ•°æ®æ ¼å¼

- **æ–‡ä»¶æ ¼å¼**: NumPyæ•°ç»„ (`.npy`)
- **éŸ³é¢‘ç‰‡æ®µé•¿åº¦**: 10ç§’
- **é‡‡æ ·ç‡**: 16 kHz
- **å£°é“**: å•å£°é“
- **æ•°æ®å½¢çŠ¶**: `(N, 160000)` - Nä¸ªæ ·æœ¬ï¼Œæ¯ä¸ª160,000ä¸ªé‡‡æ ·ç‚¹
- **æ•°æ®ç±»å‹**: float32 æˆ– int16

### æ•°æ®è·å–

1. **ä»Kaggleä¸‹è½½**ï¼ˆæ¨èï¼‰:
   ```bash
   # ä½¿ç”¨Kaggle CLI
   kaggle datasets download -d bryandarquea/psg-audio-apnea-audios
   unzip psg-audio-apnea-audios.zip -d psg-audio-apnea-audios
   ```

2. **ä»Science Data Bankä¸‹è½½åŸå§‹æ•°æ®**:
   - è®¿é—® [Science Data Bank](https://www.scidb.cn/en/detail?dataSetId=778740145531650048)
   - æŒ‰ç…§ç½‘ç«™æŒ‡å¼•ä¸‹è½½åŸå§‹æ•°æ®
   - éœ€è¦è‡ªè¡Œè¿›è¡Œé¢„å¤„ç†

### æ•°æ®å¼•ç”¨

å¦‚æœä½¿ç”¨æœ¬æ•°æ®é›†è¿›è¡Œç ”ç©¶ï¼Œè¯·å¼•ç”¨åŸå§‹æ•°æ®é›†ï¼š

```
PSG-Audio Dataset
Science Data Bank
Dataset ID: 778740145531650048
URL: https://www.scidb.cn/en/detail?dataSetId=778740145531650048
```

**æ³¨æ„**: æœ¬é¡¹ç›®ä½¿ç”¨çš„æ˜¯Kaggleä¸Šçš„é¢„å¤„ç†ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬å·²å¯¹åŸå§‹æ•°æ®è¿›è¡Œäº†æ ¼å¼è½¬æ¢å’Œé¢„å¤„ç†ï¼Œæ›´é€‚åˆç›´æ¥ç”¨äºæœºå™¨å­¦ä¹ è®­ç»ƒã€‚

## å®ç°åŸç†

### 1. ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

æœ¬ç³»ç»Ÿé‡‡ç”¨ç«¯åˆ°ç«¯çš„æ·±åº¦å­¦ä¹ æ–¹æ¡ˆï¼Œä»åŸå§‹éŸ³é¢‘åˆ°æœ€ç»ˆæ£€æµ‹ç»“æœï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è®­ç»ƒé˜¶æ®µ (PCç«¯)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŸå§‹éŸ³é¢‘ â†’ é¢„å¤„ç† â†’ Melé¢‘è°±å›¾ â†’ 2D CNN â†’ åˆ†ç±»ç»“æœ            â”‚
â”‚  (10ç§’)    (é™å™ª/æ»¤æ³¢)  (64Ã—313)    (æ¨¡å‹)    (æ­£å¸¸/å‘¼å¸æš‚åœ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    [æ¨¡å‹è½¬æ¢: TorchScript]
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ¨ç†é˜¶æ®µ (ç§»åŠ¨ç«¯)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å®æ—¶éŸ³é¢‘æµ â†’ æ»‘åŠ¨çª—å£ â†’ é¢„å¤„ç† â†’ Melé¢‘è°±å›¾ â†’ æ¨¡å‹æ¨ç† â†’ ç»“æœ  â”‚
â”‚  (16kHz)    (10ç§’çª—å£)  (å¯é€‰)    (64Ã—313)   (TorchScript)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ¨¡å‹æ¶æ„è¯¦è§£

ç³»ç»Ÿé‡‡ç”¨2D CNNæ¶æ„ï¼Œä¸“é—¨è®¾è®¡ç”¨äºå¤„ç†Melé¢‘è°±å›¾ï¼š

```
è¾“å…¥: Melé¢‘è°±å›¾ (1, 64, 313) - 10ç§’éŸ³é¢‘ @ 16kHz
  â†“
å·ç§¯å±‚1: Conv2d(1â†’48, 3Ã—3) + ReLU + CBAMæ³¨æ„åŠ› + MaxPool(2Ã—2)
  â†“
å·ç§¯å±‚2: Conv2d(48â†’96, 3Ã—3) + ReLU + CBAMæ³¨æ„åŠ› + MaxPool(2Ã—2)
  â†“
å·ç§¯å±‚3: Conv2d(96â†’192, 3Ã—3) + ReLU + CBAMæ³¨æ„åŠ› + MaxPool(2Ã—2)
  â†“
å·ç§¯å±‚4: Conv2d(192â†’256, 3Ã—3) + ReLU + CBAMæ³¨æ„åŠ› + MaxPool(2Ã—2)
  â†“
å…¨å±€å¹³å‡æ± åŒ– (4Ã—4) â†’ 256ç»´ç‰¹å¾å‘é‡
  â†“
å…¨è¿æ¥å±‚1: Linear(256â†’512) + ReLU + Dropout(0.5)
  â†“
å…¨è¿æ¥å±‚2: Linear(512â†’256) + ReLU + Dropout(0.5)
  â†“
å…¨è¿æ¥å±‚3: Linear(256â†’128) + ReLU
  â†“
è¾“å‡ºå±‚: Linear(128â†’2) + Softmax
  â†“
è¾“å‡º: äºŒåˆ†ç±»æ¦‚ç‡ [P(æ­£å¸¸), P(å‘¼å¸æš‚åœ)]
```

**å…³é”®ç‰¹æ€§**:
- **CBAMæ³¨æ„åŠ›æœºåˆ¶**: ç»“åˆé€šé“æ³¨æ„åŠ›å’Œç©ºé—´æ³¨æ„åŠ›ï¼Œè‡ªåŠ¨èšç„¦é‡è¦ç‰¹å¾
  - é€šé“æ³¨æ„åŠ›: å­¦ä¹ å“ªäº›é¢‘ç‡é€šé“æ›´é‡è¦
  - ç©ºé—´æ³¨æ„åŠ›: å­¦ä¹ æ—¶é—´åºåˆ—ä¸­å“ªäº›æ—¶åˆ»æ›´é‡è¦
- **æ·±åº¦ç½‘ç»œ**: 4å±‚å·ç§¯ + 3å±‚å…¨è¿æ¥ï¼Œå……åˆ†æå–éŸ³é¢‘ç‰¹å¾
- **Dropoutæ­£åˆ™åŒ–**: é˜²æ­¢è¿‡æ‹Ÿåˆï¼Œæå‡æ³›åŒ–èƒ½åŠ›

### 3. å®Œæ•´æ•°æ®å¤„ç†æµç¨‹

#### 3.1 PCç«¯è®­ç»ƒæµç¨‹

```
åŸå§‹éŸ³é¢‘æ•°æ® (10ç§’, 16kHz, å•å£°é“)
    â†“
[å¯é€‰] é™å™ªå¤„ç† (Spectral Gatingç®—æ³•)
    â†“
[å¯é€‰] å¸¦é€šæ»¤æ³¢ (Butterworth, 100-2000 Hz)
    â†“
Z-scoreå½’ä¸€åŒ–: (x - Î¼) / Ïƒ
    â†“
Melé¢‘è°±å›¾è½¬æ¢:
  - FFTçª—å£: 1024 samples
  - Hopé•¿åº¦: 512 samples
  - Melæ»¤æ³¢å™¨: 64ä¸ª (50-4000 Hz)
  - è¾“å‡º: (64, 313) çŸ©é˜µ
    â†“
[è®­ç»ƒæ—¶] æ•°æ®å¢å¼º:
  - å¢ç›Šå˜åŒ–: Â±30%
  - æ—¶é—´åç§»: Â±1ç§’
  - é«˜æ–¯å™ªå£°: SNR 5-20 dB
  - æ—¶é—´æ‹‰ä¼¸: 0.9-1.1å€
    â†“
Min-Maxå½’ä¸€åŒ–åˆ° [-1, 1]
    â†“
è¾“å…¥æ¨¡å‹: (1, 1, 64, 313)
```

#### 3.2 ç§»åŠ¨ç«¯æ¨ç†æµç¨‹

```
å®æ—¶éŸ³é¢‘æµ (16kHz, å•å£°é“)
    â†“
AudioCaptureNative (åŸç”Ÿæ¨¡å—)
  - Android: AudioRecord API
  - iOS: AVAudioEngine
    â†“
AudioProcessor (æ»‘åŠ¨çª—å£)
  - çª—å£å¤§å°: 10ç§’ (160,000 samples)
  - æ­¥é•¿: 5ç§’ (80,000 samples)
  - æ¯5ç§’æå–ä¸€ä¸ªçª—å£
    â†“
[å¯é€‰] AudioPreprocessor
  - é™å™ª: Spectral Gating
  - å¸¦é€šæ»¤æ³¢: Butterworth (100-2000 Hz)
    â†“
ModelInference.preprocessAudio()
  - Z-scoreå½’ä¸€åŒ–
  - Melé¢‘è°±å›¾ç”Ÿæˆ (MelSpectrogramGenerator)
    * FFT: 1024
    * Hop: 512
    * Melæ»¤æ³¢å™¨: 64ä¸ª
    * è¾“å‡º: 64Ã—313 = 20,032 å…ƒç´ 
  - Min-Maxå½’ä¸€åŒ–åˆ° [-1, 1]
    â†“
PyTorchNative.predict() (åŸç”Ÿæ¨¡å—)
  - åŠ è½½TorchScriptæ¨¡å‹
  - æ¨ç†: (1, 1, 64, 313) â†’ (2,)
  - Temperature Scaling (å¯é€‰)
    â†“
ç»“æœåå¤„ç†
  - Softmaxå½’ä¸€åŒ–
  - ç½®ä¿¡åº¦è®¡ç®—
    â†“
UIæ˜¾ç¤º
  - å®æ—¶ç»“æœ
  - å†å²è®°å½•
  - ç»Ÿè®¡ä¿¡æ¯
```

#### 3.3 Melé¢‘è°±å›¾ç”Ÿæˆè¯¦è§£

Melé¢‘è°±å›¾æ˜¯éŸ³é¢‘ä¿¡å·åœ¨Melé¢‘ç‡å°ºåº¦ä¸Šçš„æ—¶é¢‘è¡¨ç¤ºï¼Œç”Ÿæˆè¿‡ç¨‹å¦‚ä¸‹ï¼š

1. **åˆ†å¸§**: å°†10ç§’éŸ³é¢‘ (160,000 samples) åˆ†æˆé‡å çš„å¸§
   - å¸§é•¿: 1024 samples (64ms @ 16kHz)
   - å¸§ç§»: 512 samples (32ms)
   - æ€»å¸§æ•°: (160000 + 1024) / 512 = 313 å¸§ (è€ƒè™‘center=Trueå¡«å……)

2. **FFT**: å¯¹æ¯å¸§è¿›è¡Œå¿«é€Ÿå‚…é‡Œå¶å˜æ¢
   - è¾“å…¥: 1024ä¸ªæ—¶åŸŸæ ·æœ¬
   - è¾“å‡º: 513ä¸ªé¢‘åŸŸç³»æ•° (å¤æ•°)

3. **åŠŸç‡è°±**: è®¡ç®—åŠŸç‡è°±å¯†åº¦
   - `P = |FFT|Â²`

4. **Melæ»¤æ³¢å™¨ç»„**: åº”ç”¨64ä¸ªMelæ»¤æ³¢å™¨
   - Melé¢‘ç‡: å°†çº¿æ€§é¢‘ç‡è½¬æ¢ä¸ºMelé¢‘ç‡ (æ›´ç¬¦åˆäººè€³æ„ŸçŸ¥)
   - é¢‘ç‡èŒƒå›´: 50-4000 Hz
   - è¾“å‡º: 64ç»´Melé¢‘è°±

5. **å¯¹æ•°è½¬æ¢**: è½¬æ¢ä¸ºåˆ†è´ (dB) å°ºåº¦
   - `Mel_db = 10 * log10(Mel + Îµ)`

6. **å½’ä¸€åŒ–**: Min-Maxå½’ä¸€åŒ–åˆ° [-1, 1]

### 4. è®­ç»ƒç­–ç•¥

#### 4.1 æŸå¤±å‡½æ•°

- **ç±»åˆ«æƒé‡**: å¢å¼ºå‘¼å¸æš‚åœç±»æƒé‡ï¼Œå‡å°‘æ¼è¯Š
  - æ­£å¸¸ç±»æƒé‡: 1.0
  - å‘¼å¸æš‚åœç±»æƒé‡: 2.0-3.0 (æ ¹æ®æ•°æ®é›†ä¸å¹³è¡¡ç¨‹åº¦è°ƒæ•´)
- **Label Smoothing**: 0.1å¹³æ»‘å› å­ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ
- **å¯é€‰Focal Loss**: å…³æ³¨å›°éš¾æ ·æœ¬ï¼Œæå‡å¬å›ç‡
  - `FL = -Î±(1-p)^Î³ log(p)`

#### 4.2 ä¼˜åŒ–å™¨é…ç½®

- **ä¼˜åŒ–å™¨**: Adam
- **å­¦ä¹ ç‡**: 1e-4 åˆ° 2e-4
- **æƒé‡è¡°å‡**: 1e-4 (L2æ­£åˆ™åŒ–)
- **å­¦ä¹ ç‡è°ƒåº¦**: 
  - ReduceLROnPlateau: éªŒè¯é›†æŒ‡æ ‡ä¸æå‡æ—¶é™ä½å­¦ä¹ ç‡
  - CosineAnnealingLR: ä½™å¼¦é€€ç«è°ƒåº¦

#### 4.3 è®­ç»ƒæŠ€å·§

- **æ··åˆç²¾åº¦è®­ç»ƒ**: ä½¿ç”¨AMPåŠ é€Ÿè®­ç»ƒï¼Œé™ä½æ˜¾å­˜å ç”¨ (2å€é€Ÿåº¦æå‡)
- **æ¢¯åº¦è£å‰ª**: æœ€å¤§æ¢¯åº¦èŒƒæ•°1.0ï¼Œç¨³å®šè®­ç»ƒ
- **æ—©åœæœºåˆ¶**: éªŒè¯é›†F1åˆ†æ•°7ä¸ªepochæ— æå‡åˆ™åœæ­¢
- **æœ€ä½³æ¨¡å‹ä¿å­˜**: åŸºäºéªŒè¯é›†F1åˆ†æ•°ä¿å­˜æœ€ä½³æ¨¡å‹

### 5. ç§»åŠ¨ç«¯æ£€æµ‹ç®—æ³•

#### 5.1 æ»‘åŠ¨çª—å£ç®—æ³•

ç§»åŠ¨ç«¯ä½¿ç”¨æ»‘åŠ¨çª—å£å®ç°è¿ç»­ç›‘æµ‹ï¼Œé¿å…é‡å¤è®¡ç®—ï¼š

```
æ—¶é—´è½´: 0s â”€â”€â”€â”€â”€â”€ 5s â”€â”€â”€â”€â”€â”€ 10s â”€â”€â”€â”€â”€â”€ 15s â”€â”€â”€â”€â”€â”€ 20s
çª—å£1:  [â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€]  (0-10s)
çª—å£2:          [â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€]  (5-15s)
çª—å£3:                   [â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€]  (10-20s)
```

- **çª—å£å¤§å°**: 10ç§’éŸ³é¢‘ (160,000 samples @ 16kHz)
- **æ­¥é•¿**: 5ç§’ (80,000 samples) - æ¯5ç§’è¿›è¡Œä¸€æ¬¡æ£€æµ‹
- **é‡å **: 50%é‡å ï¼Œç¡®ä¿ä¸é—æ¼äº‹ä»¶
- **ç¼“å†²åŒºç®¡ç†**: ç»´æŠ¤ä¸€ä¸ªæ»‘åŠ¨ç¼“å†²åŒºï¼Œè‡ªåŠ¨ä¸¢å¼ƒæ—§æ•°æ®

#### 5.2 å®æ—¶éŸ³é¢‘æ•è·

- **Android**: ä½¿ç”¨ `AudioRecord` API
  - é‡‡æ ·ç‡: 16kHz
  - å£°é“: å•å£°é“ (MONO)
  - ç¼–ç : PCM_16BIT
  - ç¼“å†²åŒºå¤§å°: åŠ¨æ€è°ƒæ•´
  
- **iOS**: ä½¿ç”¨ `AVAudioEngine`
  - é‡‡æ ·ç‡: 16kHz
  - å£°é“: å•å£°é“
  - æ ¼å¼: AVAudioFormat

#### 5.3 ç»“æœå±•ç¤ºä¸ç»Ÿè®¡

- **å®æ—¶æ˜¾ç¤º**: å½“å‰æ£€æµ‹ç»“æœå’Œç½®ä¿¡åº¦
- **å†å²è®°å½•**: ä¿å­˜æœ€è¿‘20æ¬¡æ£€æµ‹ç»“æœ
- **ç»Ÿè®¡ä¿¡æ¯**: 
  - Apneaæ¯”ä¾‹: æœ€è¿‘Næ¬¡æ£€æµ‹ä¸­å‘¼å¸æš‚åœçš„æ¯”ä¾‹
  - é£é™©è¯„ä¼°: åŸºäºæ¯”ä¾‹çš„ç®€å•é£é™©è¯„ä¼°

## ç¯å¢ƒè¦æ±‚

### PCç«¯è®­ç»ƒ/æ£€æµ‹

- **Python**: >= 3.7
- **PyTorch**: >= 1.9.0
- **CUDA**: >= 10.2 (å¯é€‰ï¼Œç”¨äºGPUåŠ é€Ÿ)
- **æ“ä½œç³»ç»Ÿ**: Windows / Linux / macOS

### ç§»åŠ¨ç«¯å¼€å‘

- **Node.js**: >= 16
- **React Native**: 0.82.1
- **Android Studio**: æœ€æ–°ç‰ˆæœ¬ (Androidå¼€å‘)
- **Xcode**: æœ€æ–°ç‰ˆæœ¬ (iOSå¼€å‘ï¼Œä»…macOS)

## ä»é›¶å¼€å§‹éƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨ä»é›¶å¼€å§‹å®Œæ•´éƒ¨ç½²æ•´ä¸ªé¡¹ç›®ï¼ŒåŒ…æ‹¬PCç«¯è®­ç»ƒå’Œç§»åŠ¨ç«¯åº”ç”¨ã€‚

### ç¬¬ä¸€éƒ¨åˆ†: PCç«¯ç¯å¢ƒæ­å»º

#### æ­¥éª¤1: å®‰è£…Pythonç¯å¢ƒ

**Windows**:
```bash
# 1. ä¸‹è½½å¹¶å®‰è£…Python 3.8+ (æ¨è3.9æˆ–3.10)
# ä» https://www.python.org/downloads/ ä¸‹è½½

# 2. éªŒè¯å®‰è£…
python --version
pip --version

# 3. (å¯é€‰) åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv
venv\Scripts\activate  # Windows
```

**Linux/macOS**:
```bash
# ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…Python
# Ubuntu/Debian:
sudo apt-get update
sudo apt-get install python3 python3-pip python3-venv

# macOS (ä½¿ç”¨Homebrew):
brew install python3

# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python3 -m venv venv
source venv/bin/activate  # Linux/macOS
```

#### æ­¥éª¤2: å®‰è£…PyTorch

æ ¹æ®æ‚¨çš„ç³»ç»Ÿé€‰æ‹©å®‰è£…å‘½ä»¤ï¼š

**CPUç‰ˆæœ¬**:
```bash
pip install torch torchvision torchaudio
```

**GPUç‰ˆæœ¬ (CUDA)**:
```bash
# CUDA 11.8
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118

# CUDA 12.1
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

éªŒè¯å®‰è£…:
```bash
python -c "import torch; print(torch.__version__); print(torch.cuda.is_available())"
```

#### æ­¥éª¤3: å®‰è£…é¡¹ç›®ä¾èµ–

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd apnea

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

**ä¸»è¦ä¾èµ–è¯´æ˜**:
- `torch>=1.9.0`: æ·±åº¦å­¦ä¹ æ¡†æ¶
- `torchaudio>=0.9.0`: éŸ³é¢‘å¤„ç† (Melé¢‘è°±å›¾è½¬æ¢)
- `numpy>=1.19.0`: æ•°å€¼è®¡ç®—
- `scipy>=1.5.0`: ä¿¡å·å¤„ç† (Butterworthæ»¤æ³¢å™¨)
- `scikit-learn>=0.24.0`: æœºå™¨å­¦ä¹ å·¥å…· (è¯„ä¼°æŒ‡æ ‡)
- `matplotlib>=3.3.0`: å¯è§†åŒ– (è®­ç»ƒæ›²çº¿)
- `sounddevice>=0.4.0`: éŸ³é¢‘æ•è· (PCç«¯å®æ—¶æ£€æµ‹)
- `noisereduce>=2.0.0`: éŸ³é¢‘é™å™ª (å¯é€‰ï¼ŒSpectral Gating)

#### æ­¥éª¤4: å‡†å¤‡æ•°æ®é›†

**ä¸‹è½½æ•°æ®é›†**:

æœ¬é¡¹ç›®ä½¿ç”¨Kaggleä¸Šçš„é¢„å¤„ç†ç‰ˆæœ¬ï¼ˆæ¨èï¼‰:

```bash
# ä½¿ç”¨Kaggle CLIä¸‹è½½
kaggle datasets download -d bryandarquea/psg-audio-apnea-audios
unzip psg-audio-apnea-audios.zip -d psg-audio-apnea-audios
```

æˆ–è€…ä» [Science Data Bank](https://www.scidb.cn/en/detail?dataSetId=778740145531650048) ä¸‹è½½åŸå§‹æ•°æ®å¹¶è‡ªè¡Œé¢„å¤„ç†ã€‚

**æ•°æ®é›†æ”¾ç½®ä½ç½®**:

å°†æ•°æ®é›†æ”¾ç½®åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `psg-audio-apnea-audios/PSG-AUDIO/APNEA_EDF/` ç›®å½•ã€‚

è¯¦ç»†çš„æ•°æ®é›†ä¿¡æ¯ã€ç»“æ„å’Œæ ¼å¼è¦æ±‚ï¼Œè¯·å‚è€ƒ [æ•°æ®é›†](#æ•°æ®é›†) éƒ¨åˆ†ã€‚

### ç¬¬äºŒéƒ¨åˆ†: ç§»åŠ¨ç«¯ç¯å¢ƒæ­å»º

#### æ­¥éª¤1: å®‰è£…Node.jså’Œnpm

**Windows**:
1. ä» [Node.jså®˜ç½‘](https://nodejs.org/) ä¸‹è½½LTSç‰ˆæœ¬ (æ¨èv18æˆ–v20)
2. å®‰è£…æ—¶é€‰æ‹©"Add to PATH"
3. éªŒè¯å®‰è£…:
```bash
node --version  # åº”è¯¥ >= 16
npm --version
```

**Linux**:
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# éªŒè¯
node --version
npm --version
```

**macOS**:
```bash
# ä½¿ç”¨Homebrew
brew install node

# éªŒè¯
node --version
npm --version
```

#### æ­¥éª¤2: å®‰è£…React Native CLI

```bash
npm install -g react-native-cli
```

#### æ­¥éª¤3: Androidå¼€å‘ç¯å¢ƒ (ä»…Androidå¼€å‘éœ€è¦)

**Windows**:
1. ä¸‹è½½å¹¶å®‰è£… [Android Studio](https://developer.android.com/studio)
2. åœ¨Android Studioä¸­:
   - æ‰“å¼€ "More Actions" â†’ "SDK Manager"
   - å®‰è£… Android SDK Platform 33 (æˆ–æ›´é«˜)
   - å®‰è£… Android SDK Build-Tools
   - å®‰è£… Android Emulator (å¯é€‰ï¼Œç”¨äºæ¨¡æ‹Ÿå™¨æµ‹è¯•)
3. é…ç½®ç¯å¢ƒå˜é‡:
   ```bash
   # æ·»åŠ åˆ°ç³»ç»Ÿç¯å¢ƒå˜é‡
   ANDROID_HOME=C:\Users\YourUsername\AppData\Local\Android\Sdk
   PATH=%PATH%;%ANDROID_HOME%\platform-tools
   PATH=%PATH%;%ANDROID_HOME%\tools
   PATH=%PATH%;%ANDROID_HOME%\tools\bin
   ```
4. éªŒè¯å®‰è£…:
   ```bash
   adb version
   ```

**Linux/macOS**:
```bash
# 1. å®‰è£…Android Studio (åŒä¸Š)

# 2. é…ç½®ç¯å¢ƒå˜é‡ (æ·»åŠ åˆ° ~/.bashrc æˆ– ~/.zshrc)
export ANDROID_HOME=$HOME/Library/Android/sdk  # macOS
# export ANDROID_HOME=$HOME/Android/Sdk  # Linux
export PATH=$PATH:$ANDROID_HOME/platform-tools
export PATH=$PATH:$ANDROID_HOME/tools
export PATH=$PATH:$ANDROID_HOME/tools/bin

# 3. é‡æ–°åŠ è½½é…ç½®
source ~/.bashrc  # æˆ– source ~/.zshrc

# 4. éªŒè¯
adb version
```

#### æ­¥éª¤4: iOSå¼€å‘ç¯å¢ƒ (ä»…iOSå¼€å‘éœ€è¦ï¼Œä»…macOS)

1. ä»App Storeå®‰è£… [Xcode](https://developer.apple.com/xcode/)
2. å®‰è£…Xcode Command Line Tools:
   ```bash
   xcode-select --install
   ```
3. å®‰è£…CocoaPods:
   ```bash
   sudo gem install cocoapods
   ```

#### æ­¥éª¤5: å®‰è£…ç§»åŠ¨åº”ç”¨ä¾èµ–

```bash
cd mobile_app_full

# å®‰è£…npmä¾èµ–
npm install

# æ³¨æ„: npm install ä¼šè‡ªåŠ¨è¿è¡Œ postinstall è„šæœ¬
# è¯¥è„šæœ¬ä¼šä½¿ç”¨ patch-package åº”ç”¨è¡¥ä¸æ–‡ä»¶
```

**é‡è¦**: å®‰è£…è¿‡ç¨‹ä¸­ä¼šè‡ªåŠ¨åº”ç”¨è¡¥ä¸ï¼Œè¯¦è§ä¸‹é¢çš„"è¡¥ä¸è¯´æ˜"éƒ¨åˆ†ã€‚

#### æ­¥éª¤6: é…ç½®AndroidåŸç”Ÿæ¨¡å—

ç¡®ä¿æ¨¡å‹æ–‡ä»¶å·²è½¬æ¢å¹¶æ”¾ç½®åœ¨æ­£ç¡®ä½ç½®:

```bash
# æ¨¡å‹æ–‡ä»¶åº”ä½äº:
mobile_app_full/android/app/src/main/assets/
  â”œâ”€â”€ apnea_model.pt
  â””â”€â”€ audio_preprocessor.pt
```

å¦‚æœè¿˜æ²¡æœ‰æ¨¡å‹æ–‡ä»¶ï¼Œéœ€è¦å…ˆå®ŒæˆPCç«¯çš„æ¨¡å‹è®­ç»ƒå’Œè½¬æ¢ã€‚

#### æ­¥éª¤7: iOSé…ç½® (ä»…iOSå¼€å‘)

```bash
cd mobile_app_full/ios
pod install
cd ..
```

### ç¬¬ä¸‰éƒ¨åˆ†: è¡¥ä¸è¯´æ˜ (é‡è¦!)

æœ¬é¡¹ç›®ä½¿ç”¨äº†ä¸¤ä¸ªè¡¥ä¸æ¥ä¿®å¤ç¬¬ä¸‰æ–¹åº“çš„å…¼å®¹æ€§é—®é¢˜ã€‚è¿™äº›è¡¥ä¸ä¼šåœ¨ `npm install` æ—¶è‡ªåŠ¨åº”ç”¨ã€‚

#### ä¸ºä»€ä¹ˆéœ€è¦è¡¥ä¸?

React Nativeç”Ÿæ€ç³»ç»Ÿä¸­çš„ä¸€äº›ç¬¬ä¸‰æ–¹åº“å¯èƒ½ä½¿ç”¨äº†è¿‡æ—¶çš„Gradleé…ç½®æˆ–ä¾èµ–è¯­æ³•ï¼Œå¯¼è‡´ä¸è¾ƒæ–°ç‰ˆæœ¬çš„Androidæ„å»ºå·¥å…·ä¸å…¼å®¹ã€‚è¡¥ä¸å…è®¸æˆ‘ä»¬åœ¨ä¸ä¿®æ”¹åŸå§‹åº“ä»£ç çš„æƒ…å†µä¸‹ä¿®å¤è¿™äº›é—®é¢˜ã€‚

#### è¡¥ä¸1: react-native-keep-awake

**é—®é¢˜**: 
- ä½¿ç”¨äº†å·²åºŸå¼ƒçš„ `jcenter()` ä»“åº“ (2021å¹´å·²å…³é—­)
- ä½¿ç”¨äº†è¿‡æ—¶çš„ `compile` ä¾èµ–é…ç½® (åº”ä½¿ç”¨ `implementation`)
- `compileSdkVersion` è¿‡ä½ (23)ï¼Œä¸æ”¯æŒJava 9+ç¼–è¯‘
- ç¼ºå°‘Javaç‰ˆæœ¬é…ç½®

**ä¿®å¤å†…å®¹**:
```diff
# 1. æ›¿æ¢åºŸå¼ƒçš„ä»“åº“
- jcenter()
+ google()
+ mavenCentral()

# 2. æ›´æ–°SDKç‰ˆæœ¬
- compileSdkVersion 23
+ compileSdkVersion 36

# 3. æ›´æ–°ä¾èµ–é…ç½®
- compile 'com.facebook.react:react-native:+'
+ implementation 'com.facebook.react:react-native:+'

# 4. æ·»åŠ Javaç‰ˆæœ¬é…ç½®
+ compileOptions {
+     sourceCompatibility JavaVersion.VERSION_17
+     targetCompatibility JavaVersion.VERSION_17
+ }
```

**è¡¥ä¸æ–‡ä»¶**: `mobile_app_full/patches/react-native-keep-awake+2.0.6.patch`

#### è¡¥ä¸2: react-native-pytorch-core

**é—®é¢˜**:
- ä½¿ç”¨äº†å·²åºŸå¼ƒçš„ `jcenter()` ä»“åº“

**ä¿®å¤å†…å®¹**:
```diff
- jcenter()
+ mavenCentral()
```

**è¡¥ä¸æ–‡ä»¶**: `mobile_app_full/patches/react-native-pytorch-core+0.2.4.patch`

#### è¡¥ä¸å¦‚ä½•å·¥ä½œ?

1. **patch-package**: ä½¿ç”¨ `patch-package` å·¥å…·ç®¡ç†è¡¥ä¸
2. **è‡ªåŠ¨åº”ç”¨**: `package.json` ä¸­çš„ `postinstall` è„šæœ¬ä¼šåœ¨ `npm install` åè‡ªåŠ¨è¿è¡Œ
   ```json
   {
     "scripts": {
       "postinstall": "patch-package"
     }
   }
   ```
3. **è¡¥ä¸ä½ç½®**: è¡¥ä¸æ–‡ä»¶ä½äº `patches/` ç›®å½•ï¼Œå‘½åæ ¼å¼ä¸º `<package-name>+<version>.patch`
4. **ç‰ˆæœ¬åŒ¹é…**: è¡¥ä¸æ–‡ä»¶ååŒ…å«ç‰ˆæœ¬å·ï¼Œç¡®ä¿åªåº”ç”¨äºåŒ¹é…çš„åŒ…ç‰ˆæœ¬

#### å¦‚æœè¡¥ä¸æœªè‡ªåŠ¨åº”ç”¨?

å¦‚æœé‡åˆ°æ„å»ºé”™è¯¯ï¼Œå¯ä»¥æ‰‹åŠ¨åº”ç”¨è¡¥ä¸:

```bash
cd mobile_app_full
npx patch-package react-native-keep-awake
npx patch-package react-native-pytorch-core
```

#### æ›´æ–°ä¾èµ–åéœ€è¦é‡æ–°åº”ç”¨è¡¥ä¸

å¦‚æœæ›´æ–°äº† `react-native-keep-awake` æˆ– `react-native-pytorch-core` çš„ç‰ˆæœ¬ï¼Œå¯èƒ½éœ€è¦æ›´æ–°è¡¥ä¸:

```bash
# 1. ä¿®æ”¹ node_modules ä¸­çš„æ–‡ä»¶
# 2. ç”Ÿæˆæ–°è¡¥ä¸
npx patch-package react-native-keep-awake
npx patch-package react-native-pytorch-core
```

## è®­ç»ƒæ¨¡å‹

### è®­ç»ƒå‘½ä»¤

```bash
python main.py \
  --data_root psg-audio-apnea-audios/PSG-AUDIO/APNEA_EDF \
  --epochs 50 \
  --batch_size 128 \
  --val_batch_size 64 \
  --lr 2e-4 \
  --weight_decay 1e-4 \
  --max_grad_norm 1.0 \
  --early_stop_patience 7 \
  --label_smoothing 0.1 \
  --scheduler cosine \
  --use_focal_loss \
  --focal_alpha 0.25 \
  --focal_gamma 3.0 \
  --augment \
  --use_amp \
  --seed 42
```

**å‚æ•°è¯´æ˜**:
- `--epochs 50`: è®­ç»ƒ50è½®ï¼Œé…åˆæ—©åœæœºåˆ¶ä½¿ç”¨
- `--use_focal_loss`: å¯ç”¨Focal Lossï¼Œå…³æ³¨å›°éš¾æ ·æœ¬ï¼Œé€‚åˆå¤„ç†ç±»åˆ«ä¸å¹³è¡¡æ•°æ®
- `--focal_gamma 3.0`: Focal Lossçš„gammaå‚æ•°ï¼Œå€¼è¶Šå¤§è¶Šå…³æ³¨å›°éš¾æ ·æœ¬
- `--scheduler cosine`: ä½¿ç”¨ä½™å¼¦é€€ç«å­¦ä¹ ç‡è°ƒåº¦ï¼Œå¹³æ»‘é™ä½å­¦ä¹ ç‡
- `--lr 2e-4`: ä½¿ç”¨Focal Lossæ—¶å»ºè®®ä½¿ç”¨è¾ƒé«˜å­¦ä¹ ç‡ï¼ˆ2e-4ï¼‰ï¼Œå› ä¸ºFocal Lossäº§ç”Ÿçš„æŸå¤±å€¼é€šå¸¸è¾ƒå°
- `--use_amp`: å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼Œå¯æå‡2å€é€Ÿåº¦å¹¶é™ä½æ˜¾å­˜å ç”¨
- `--augment`: å¯ç”¨æ•°æ®å¢å¼ºï¼Œæå‡æ¨¡å‹æ³›åŒ–èƒ½åŠ›

### è®­ç»ƒè¾“å‡º

è®­ç»ƒå®Œæˆåï¼Œæ¨¡å‹å’Œç»“æœä¿å­˜åœ¨ `outputs/` ç›®å½•:

- `apnea_2dcnn_best.pth`: æœ€ä½³æ¨¡å‹æ£€æŸ¥ç‚¹ (åŸºäºéªŒè¯é›†F1)
- `apnea_2dcnn_final.pth`: æœ€ç»ˆæ¨¡å‹æƒé‡
- `test_metrics.json`: æµ‹è¯•é›†è¯„ä¼°æŒ‡æ ‡
- `training_curves.png`: è®­ç»ƒæ›²çº¿å›¾

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **GPUåˆ©ç”¨ç‡ä¼˜åŒ–**:
   - ä½¿ç”¨ `--use_amp` å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
   - å¢å¤§ `batch_size` (æ ¹æ®GPUæ˜¾å­˜è°ƒæ•´)
   - é»˜è®¤ç¦ç”¨é™å™ªå’Œæ»¤æ³¢ (CPUå¯†é›†å‹æ“ä½œ)

2. **å†…å­˜ä¼˜åŒ–**:
   - ä½¿ç”¨ `--val_batch_size` å‡å°éªŒè¯æ‰¹æ¬¡å¤§å°
   - å‡å°‘ `--num_workers` (Windowsæ¨è0-4)
   - é™ä½ `--prefetch_factor` (å†…å­˜ç´§å¼ æ—¶)

3. **è®­ç»ƒåŠ é€Ÿ**:
   - å¯ç”¨ `--use_amp` (2å€é€Ÿåº¦æå‡)
   - ä½¿ç”¨ `torch.compile` (PyTorch 2.0+)
   - ç¦ç”¨ `--denoise` å’Œ `--bandpass` (é»˜è®¤å·²ç¦ç”¨)

## æ¨¡å‹è½¬æ¢

è®­ç»ƒå®Œæˆåï¼Œéœ€è¦å°†æ¨¡å‹è½¬æ¢ä¸ºç§»åŠ¨ç«¯å¯ç”¨çš„TorchScriptæ ¼å¼:

```bash
python convert_model_for_mobile.py \
  --model_path outputs/apnea_2dcnn_best.pth \
  --output_dir mobile_app_full/assets
```

è½¬æ¢åçš„æ–‡ä»¶:
- `apnea_model.pt`: ä¸»æ¨¡å‹ (TorchScriptæ ¼å¼)
- `audio_preprocessor.pt`: éŸ³é¢‘é¢„å¤„ç†æ¨¡å— (Melé¢‘è°±å›¾è½¬æ¢)

## PCç«¯å®æ—¶æ£€æµ‹

ä½¿ç”¨è®­ç»ƒå¥½çš„æ¨¡å‹è¿›è¡Œå®æ—¶éº¦å…‹é£æ£€æµ‹:

```bash
python predict_microphone.py \
  --model_path outputs/apnea_2dcnn_best.pth \
  --duration 10.0
```

### å‚æ•°è¯´æ˜

- `--model_path`: æ¨¡å‹æ–‡ä»¶è·¯å¾„
- `--duration`: æ¯æ¬¡å½•éŸ³æ—¶é•¿ (ç§’ï¼Œé»˜è®¤10ç§’)
- `--single`: å•æ¬¡æ£€æµ‹æ¨¡å¼ (éœ€è¦æ‰‹åŠ¨è§¦å‘)
- `--no_denoise`: ç¦ç”¨é™å™ª
- `--no_bandpass`: ç¦ç”¨å¸¦é€šæ»¤æ³¢
- `--list_devices`: åˆ—å‡ºå¯ç”¨éŸ³é¢‘è®¾å¤‡

### è¿ç»­ç›‘æ§æ¨¡å¼

é»˜è®¤æƒ…å†µä¸‹ï¼Œç¨‹åºä¼šæ¯10ç§’è‡ªåŠ¨å½•éŸ³å¹¶åˆ†æã€‚æŒ‰ `Ctrl+C` åœæ­¢ç›‘æ§ã€‚

## ç§»åŠ¨ç«¯éƒ¨ç½²è¯¦ç»†æ­¥éª¤

### å‰ç½®æ¡ä»¶

åœ¨å¼€å§‹ç§»åŠ¨ç«¯éƒ¨ç½²ä¹‹å‰ï¼Œè¯·ç¡®ä¿:
1. âœ… å·²å®ŒæˆPCç«¯æ¨¡å‹è®­ç»ƒ (è§"è®­ç»ƒæ¨¡å‹"éƒ¨åˆ†)
2. âœ… å·²å®Œæˆæ¨¡å‹è½¬æ¢ (è§"æ¨¡å‹è½¬æ¢"éƒ¨åˆ†)
3. âœ… å·²å®Œæˆç§»åŠ¨ç«¯ç¯å¢ƒæ­å»º (è§"ä»é›¶å¼€å§‹éƒ¨ç½²æŒ‡å— - ç¬¬äºŒéƒ¨åˆ†")

### æ­¥éª¤1: è½¬æ¢å¹¶å¤åˆ¶æ¨¡å‹æ–‡ä»¶

é¦–å…ˆï¼Œå°†è®­ç»ƒå¥½çš„æ¨¡å‹è½¬æ¢ä¸ºç§»åŠ¨ç«¯æ ¼å¼:

```bash
# ä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ
python convert_model_for_mobile.py \
  --model_path outputs/apnea_2dcnn_best.pth \
  --output_dir mobile_app_full/assets
```

ç„¶åï¼Œå°†æ¨¡å‹æ–‡ä»¶å¤åˆ¶åˆ°Android assetsç›®å½•:

```bash
# Windows
copy mobile_app_full\assets\*.pt mobile_app_full\android\app\src\main\assets\

# Linux/macOS
cp mobile_app_full/assets/*.pt mobile_app_full/android/app/src/main/assets/
```

**Androidæ¨¡å‹æ–‡ä»¶ä½ç½®**:
```
mobile_app_full/android/app/src/main/assets/
  â”œâ”€â”€ apnea_model.pt              # ä¸»æ¨¡å‹ (TorchScriptæ ¼å¼)
  â””â”€â”€ audio_preprocessor.pt       # é¢„å¤„ç†æ¨¡å— (å¯é€‰ï¼Œç§»åŠ¨ç«¯ä½¿ç”¨JSå®ç°)
```

**iOSæ¨¡å‹æ–‡ä»¶**: åœ¨Xcodeä¸­æ‰‹åŠ¨æ·»åŠ æ¨¡å‹æ–‡ä»¶åˆ°é¡¹ç›®èµ„æº:
1. æ‰“å¼€ `mobile_app_full/ios/mobile_app_full.xcworkspace`
2. å³é”®ç‚¹å‡»é¡¹ç›® â†’ "Add Files to..."
3. é€‰æ‹© `mobile_app_full/assets/` ç›®å½•ä¸‹çš„ `.pt` æ–‡ä»¶

### æ­¥éª¤2: å®‰è£…ä¾èµ–å¹¶åº”ç”¨è¡¥ä¸

```bash
cd mobile_app_full

# å®‰è£…npmä¾èµ– (ä¼šè‡ªåŠ¨åº”ç”¨è¡¥ä¸)
npm install

# å¦‚æœè¡¥ä¸æœªè‡ªåŠ¨åº”ç”¨ï¼Œæ‰‹åŠ¨è¿è¡Œ:
npx patch-package react-native-keep-awake
npx patch-package react-native-pytorch-core
```

### æ­¥éª¤3: é…ç½®æƒé™

#### Androidæƒé™é…ç½®

ç¡®ä¿ `mobile_app_full/android/app/src/main/AndroidManifest.xml` åŒ…å«ä»¥ä¸‹æƒé™:

```xml
<uses-permission android:name="android.permission.RECORD_AUDIO" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
```

#### iOSæƒé™é…ç½®

åœ¨ `mobile_app_full/ios/mobile_app_full/Info.plist` ä¸­æ·»åŠ :

```xml
<key>NSMicrophoneUsageDescription</key>
<string>éœ€è¦è®¿é—®éº¦å…‹é£ä»¥è¿›è¡Œç¡çœ å‘¼å¸æš‚åœæ£€æµ‹</string>
```

### æ­¥éª¤4: è¿è¡Œå¼€å‘ç‰ˆæœ¬

#### Android

**æ–¹æ³•1: ä½¿ç”¨React Native CLI**
```bash
cd mobile_app_full

# å¯åŠ¨Metro bundler (æ–°ç»ˆç«¯çª—å£)
npm start

# è¿è¡ŒAndroidåº”ç”¨ (å¦ä¸€ä¸ªç»ˆç«¯çª—å£)
npm run android
```

**æ–¹æ³•2: ä½¿ç”¨Android Studio**
1. æ‰“å¼€Android Studio
2. é€‰æ‹© "Open an Existing Project"
3. å¯¼èˆªåˆ° `mobile_app_full/android/` ç›®å½•
4. ç­‰å¾…GradleåŒæ­¥å®Œæˆ
5. ç‚¹å‡» "Run" æŒ‰é’®

**é¦–æ¬¡è¿è¡Œæ³¨æ„äº‹é¡¹**:
- ç¡®ä¿å·²è¿æ¥Androidè®¾å¤‡æˆ–å¯åŠ¨æ¨¡æ‹Ÿå™¨
- é¦–æ¬¡æ„å»ºå¯èƒ½éœ€è¦10-20åˆ†é’Ÿ (ä¸‹è½½ä¾èµ–)
- å¦‚æœé‡åˆ°æ„å»ºé”™è¯¯ï¼Œæ£€æŸ¥è¡¥ä¸æ˜¯å¦å·²åº”ç”¨

#### iOS (ä»…macOS)

```bash
cd mobile_app_full

# å®‰è£…CocoaPodsä¾èµ–
cd ios
pod install
cd ..

# å¯åŠ¨Metro bundler (æ–°ç»ˆç«¯çª—å£)
npm start

# è¿è¡ŒiOSåº”ç”¨ (å¦ä¸€ä¸ªç»ˆç«¯çª—å£)
npm run ios
```

### æ­¥éª¤5: è°ƒè¯•å’Œæµ‹è¯•

#### æŸ¥çœ‹æ—¥å¿—

**Android**:
```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
adb logcat

# åªæŸ¥çœ‹React Nativeæ—¥å¿—
adb logcat *:S ReactNative:V ReactNativeJS:V

# æŸ¥çœ‹åº”ç”¨ç‰¹å®šæ—¥å¿—
adb logcat | grep "ApneaDetection"
```

**iOS**:
- åœ¨Xcodeä¸­æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹æ—¥å¿—
- æˆ–ä½¿ç”¨ `react-native log-ios` å‘½ä»¤

#### å¸¸è§é—®é¢˜æ’æŸ¥

1. **æ¨¡å‹åŠ è½½å¤±è´¥**:
   - æ£€æŸ¥æ¨¡å‹æ–‡ä»¶æ˜¯å¦åœ¨æ­£ç¡®ä½ç½®
   - æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡® (Androidä½¿ç”¨ `asset://` åè®®)
   - æŸ¥çœ‹åŸç”Ÿæ¨¡å—æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯

2. **éŸ³é¢‘æ•è·å¤±è´¥**:
   - æ£€æŸ¥éº¦å…‹é£æƒé™æ˜¯å¦å·²æˆäºˆ
   - Android: åœ¨è®¾ç½®ä¸­æ‰‹åŠ¨æˆäºˆæƒé™
   - iOS: é¦–æ¬¡è¿è¡Œæ—¶ä¼šå¼¹å‡ºæƒé™è¯·æ±‚

3. **æ„å»ºå¤±è´¥**:
   - æ£€æŸ¥è¡¥ä¸æ˜¯å¦å·²åº”ç”¨: `ls mobile_app_full/patches/`
   - æ¸…ç†æ„å»ºç¼“å­˜: `cd android && ./gradlew clean`
   - é‡æ–°å®‰è£…ä¾èµ–: `rm -rf node_modules && npm install`

### æ­¥éª¤6: æ„å»ºå‘å¸ƒç‰ˆæœ¬

#### Android APK

**Debugç‰ˆæœ¬** (ç”¨äºæµ‹è¯•):
```bash
cd mobile_app_full/android
./gradlew assembleDebug
```

APKæ–‡ä»¶ä½äº: `android/app/build/outputs/apk/debug/app-debug.apk`

**Releaseç‰ˆæœ¬** (ç”¨äºåˆ†å‘):
```bash
cd mobile_app_full/android

# 1. ç”Ÿæˆç­¾åå¯†é’¥ (é¦–æ¬¡éœ€è¦)
keytool -genkeypair -v -storetype PKCS12 -keystore my-release-key.keystore \
  -alias my-key-alias -keyalg RSA -keysize 2048 -validity 10000

# 2. é…ç½®ç­¾å (ç¼–è¾‘ android/gradle.properties)
# æ·»åŠ :
# MYAPP_RELEASE_STORE_FILE=my-release-key.keystore
# MYAPP_RELEASE_KEY_ALIAS=my-key-alias
# MYAPP_RELEASE_STORE_PASSWORD=*****
# MYAPP_RELEASE_KEY_PASSWORD=*****

# 3. æ„å»ºRelease APK
./gradlew assembleRelease
```

APKæ–‡ä»¶ä½äº: `android/app/build/outputs/apk/release/app-release.apk`

**AABæ ¼å¼** (ç”¨äºGoogle Play):
```bash
./gradlew bundleRelease
```

AABæ–‡ä»¶ä½äº: `android/app/build/outputs/bundle/release/app-release.aab`

#### iOS IPA

1. åœ¨Xcodeä¸­æ‰“å¼€ `mobile_app_full/ios/mobile_app_full.xcworkspace`
2. é€‰æ‹© "Product" â†’ "Scheme" â†’ "mobile_app_full"
3. é€‰æ‹© "Any iOS Device" ä½œä¸ºç›®æ ‡
4. é€‰æ‹© "Product" â†’ "Archive"
5. ç­‰å¾…å½’æ¡£å®Œæˆ
6. åœ¨Organizerçª—å£ä¸­é€‰æ‹© "Distribute App"
7. é€‰æ‹©åˆ†å‘æ–¹å¼:
   - **App Store Connect**: ä¸Šä¼ åˆ°App Store
   - **Ad Hoc**: åˆ†å‘ç»™æµ‹è¯•è®¾å¤‡
   - **Enterprise**: ä¼ä¸šå†…éƒ¨åˆ†å‘
   - **Development**: å¼€å‘ç‰ˆæœ¬

## é¡¹ç›®ç»“æ„

```
apnea/
â”œâ”€â”€ main.py                          # ä¸»è®­ç»ƒè„šæœ¬
â”œâ”€â”€ convert_model_for_mobile.py      # æ¨¡å‹è½¬æ¢è„šæœ¬
â”œâ”€â”€ predict_microphone.py            # PCç«¯å®æ—¶æ£€æµ‹
â”œâ”€â”€ requirements.txt                 # Pythonä¾èµ–
â”œâ”€â”€ README.md                        # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ outputs/                         # è®­ç»ƒè¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ apnea_2dcnn_best.pth        # æœ€ä½³æ¨¡å‹
â”‚   â”œâ”€â”€ apnea_2dcnn_final.pth       # æœ€ç»ˆæ¨¡å‹
â”‚   â”œâ”€â”€ test_metrics.json           # æµ‹è¯•æŒ‡æ ‡
â”‚   â””â”€â”€ training_curves.png         # è®­ç»ƒæ›²çº¿
â”‚
â”œâ”€â”€ assets/                          # æ¨¡å‹èµ„æº
â”‚   â”œâ”€â”€ apnea_model.pt              # è½¬æ¢åçš„æ¨¡å‹
â”‚   â””â”€â”€ audio_preprocessor.pt       # é¢„å¤„ç†æ¨¡å—
â”‚
â”œâ”€â”€ mobile_app_full/                 # React Nativeç§»åŠ¨åº”ç”¨
â”‚   â”œâ”€â”€ App.tsx                     # ä¸»åº”ç”¨ç»„ä»¶
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ AudioProcessor.ts       # éŸ³é¢‘å¤„ç†å’Œæ»‘åŠ¨çª—å£
â”‚   â”‚   â”œâ”€â”€ ModelInference.ts      # æ¨¡å‹æ¨ç†å°è£…
â”‚   â”‚   â”œâ”€â”€ AudioRecorder.ts       # éŸ³é¢‘å½•åˆ¶
â”‚   â”‚   â”œâ”€â”€ AudioCaptureNative.ts  # åŸç”ŸéŸ³é¢‘æ•è·
â”‚   â”‚   â””â”€â”€ PyTorchNative.ts       # PyTorchåŸç”Ÿæ¨¡å—
â”‚   â”œâ”€â”€ android/                    # AndroidåŸç”Ÿä»£ç 
â”‚   â”‚   â””â”€â”€ app/src/main/
â”‚   â”‚       â”œâ”€â”€ java/.../           # KotlinåŸç”Ÿæ¨¡å—
â”‚   â”‚       â””â”€â”€ assets/             # æ¨¡å‹æ–‡ä»¶
â”‚   â””â”€â”€ ios/                        # iOSåŸç”Ÿä»£ç 
â”‚       â””â”€â”€ mobile_app_full/
â”‚           â””â”€â”€ *.swift             # SwiftåŸç”Ÿæ¨¡å—
â”‚
â””â”€â”€ psg-audio-apnea-audios/         # æ•°æ®é›†ç›®å½•
    â””â”€â”€ PSG-AUDIO/
        â””â”€â”€ APNEA_EDF/
            â””â”€â”€ patient_*/          # æ‚£è€…æ•°æ®
```

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡GitHub Issuesè”ç³»ã€‚

---

**æ³¨æ„**: æœ¬ç³»ç»Ÿä»…ç”¨äºç ”ç©¶å’Œæ•™è‚²ç›®çš„ï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—è¯Šæ–­ã€‚å¦‚æœ‰å¥åº·é—®é¢˜ï¼Œè¯·å’¨è¯¢ä¸“ä¸šåŒ»ç”Ÿã€‚

